(()=>{"use strict";var t={873:(t,o,e)=>{var r=e(751),s=e(641);const a={id:"app"};function i(t,o){const e=(0,s.g2)("router-view");return(0,s.uX)(),(0,s.CE)("div",a,[(0,s.bF)(e)])}var l=e(262);const n={},c=(0,l.A)(n,[["render",i]]),d=c;var u=e(499),h=e(33);const k={class:"container"},p={class:"card"},b={class:"form-group"},y=["value"],m={key:0,class:"form-group"};function f(t,o,e,a,i,l){return(0,s.uX)(),(0,s.CE)("div",k,[(0,s.Lk)("div",p,[o[8]||(o[8]=(0,s.Lk)("h1",null,"Вход в систему брокера",-1)),(0,s.Lk)("form",{onSubmit:o[3]||(o[3]=(0,r.D$)((...t)=>l.login&&l.login(...t),["prevent"]))},[(0,s.Lk)("div",b,[o[5]||(o[5]=(0,s.Lk)("label",null,"Выберите брокера:",-1)),(0,s.bo)((0,s.Lk)("select",{"onUpdate:modelValue":o[0]||(o[0]=t=>i.selectedBrokerId=t)},[o[4]||(o[4]=(0,s.Lk)("option",{value:""},"Новый брокер",-1)),((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(i.brokers,t=>((0,s.uX)(),(0,s.CE)("option",{key:t.id,value:t.id},(0,h.v_)(t.name),9,y))),128))],512),[[r.u1,i.selectedBrokerId]])]),i.selectedBrokerId?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("div",m,[o[6]||(o[6]=(0,s.Lk)("label",null,"Имя нового брокера:",-1)),(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":o[1]||(o[1]=t=>i.newBrokerName=t),required:""},null,512),[[r.Jo,i.newBrokerName]])])),o[7]||(o[7]=(0,s.Lk)("button",{type:"submit"},"Войти",-1)),(0,s.Lk)("button",{type:"button",onClick:o[2]||(o[2]=(...t)=>l.goToAdmin&&l.goToAdmin(...t))},"Администратор")],32)])])}const v={data(){return{brokers:[],selectedBrokerId:"",newBrokerName:""}},async mounted(){const t=await fetch("http://localhost:3002/api/brokers");this.brokers=await t.json()},methods:{async login(){let t=this.selectedBrokerId;if(!t){const o=await fetch("http://localhost:3002/api/brokers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.newBrokerName})}),e=await o.json();t=e.id}this.$router.push(`/broker/${t}`)},goToAdmin(){this.$router.push("/admin")}}},L=(0,l.A)(v,[["render",f]]),g=L,C={class:"container"},S={class:"header"},w={class:"section"},D={class:"actions"},P=["onClick"],_=["onClick"],T=["onClick"],E={class:"section"},$={class:"portfolio-summary"},I={class:"summary-item"},x={class:"summary-item"},F={class:"modal-content"},X={class:"form-group"},O={class:"dialog-actions"},j=["disabled"],B={class:"modal-content chart-modal"},A={class:"chart-container"},H={key:1,class:"chart-loading"};function U(t,o,e,a,i,l){const n=(0,s.g2)("Line");return(0,s.uX)(),(0,s.CE)("div",C,[(0,s.Lk)("div",S,[(0,s.Lk)("h1",null,"Брокер: "+(0,h.v_)(i.broker?.name),1),(0,s.Lk)("p",null,"Текущая дата: "+(0,h.v_)(i.currentDate),1)]),(0,s.Lk)("div",w,[o[7]||(o[7]=(0,s.Lk)("h2",null,"Цены акций",-1)),(0,s.Lk)("table",null,[o[6]||(o[6]=(0,s.Lk)("thead",null,[(0,s.Lk)("tr",null,[(0,s.Lk)("th",null,"Акция"),(0,s.Lk)("th",null,"Цена"),(0,s.Lk)("th",null,"Действия")])],-1)),(0,s.Lk)("tbody",null,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(i.currentStocks,t=>((0,s.uX)(),(0,s.CE)("tr",{key:t.symbol},[(0,s.Lk)("td",null,(0,h.v_)(t.symbol),1),(0,s.Lk)("td",null,"$"+(0,h.v_)((t.currentPrice||0).toFixed(2)),1),(0,s.Lk)("td",D,[(0,s.Lk)("button",{onClick:o=>l.openTradeDialog(t.symbol,"buy")},"Купить",8,P),(0,s.Lk)("button",{onClick:o=>l.openTradeDialog(t.symbol,"sell")},"Продать",8,_),(0,s.Lk)("button",{onClick:o=>l.showStockChart(t.symbol)},"График",8,T)])]))),128))])])]),(0,s.Lk)("div",E,[o[12]||(o[12]=(0,s.Lk)("h2",null,"Портфель",-1)),(0,s.Lk)("div",$,[(0,s.Lk)("div",I,[o[8]||(o[8]=(0,s.Lk)("span",null,"Общие средства:",-1)),(0,s.Lk)("span",null,"$"+(0,h.v_)((i.portfolio?.totalValue||0).toFixed(2)),1)]),(0,s.Lk)("div",x,[o[9]||(o[9]=(0,s.Lk)("span",null,"Денежные средства:",-1)),(0,s.Lk)("span",null,"$"+(0,h.v_)((i.broker?.cash||0).toFixed(2)),1)]),(0,s.Lk)("div",{class:(0,h.C4)(["summary-item",l.getProfitClass(i.portfolio?.totalProfit||0)])},[o[10]||(o[10]=(0,s.Lk)("span",null,"Прибыль:",-1)),(0,s.Lk)("span",null,"$"+(0,h.v_)((i.portfolio?.totalProfit||0).toFixed(2)),1)],2)]),(0,s.Lk)("table",null,[o[11]||(o[11]=(0,s.Lk)("thead",null,[(0,s.Lk)("tr",null,[(0,s.Lk)("th",null,"Акция"),(0,s.Lk)("th",null,"Кол-во"),(0,s.Lk)("th",null,"Ср. цена"),(0,s.Lk)("th",null,"Тек. цена"),(0,s.Lk)("th",null,"Стоимость"),(0,s.Lk)("th",null,"Прибыль")])],-1)),(0,s.Lk)("tbody",null,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(i.portfolio?.stocks||[],t=>((0,s.uX)(),(0,s.CE)("tr",{key:t.symbol},[(0,s.Lk)("td",null,(0,h.v_)(t.symbol),1),(0,s.Lk)("td",null,(0,h.v_)(t.quantity||0),1),(0,s.Lk)("td",null,"$"+(0,h.v_)((t.averagePrice||0).toFixed(2)),1),(0,s.Lk)("td",null,"$"+(0,h.v_)((t.currentPrice||0).toFixed(2)),1),(0,s.Lk)("td",null,"$"+(0,h.v_)((t.value||0).toFixed(2)),1),(0,s.Lk)("td",{class:(0,h.C4)(l.getStockProfitClass(t))}," $"+(0,h.v_)((t.profit||0).toFixed(2)),3)]))),128))])])]),i.showDialog?((0,s.uX)(),(0,s.CE)("div",{key:0,class:"modal",onClick:o[3]||(o[3]=(0,r.D$)(t=>i.showDialog=!1,["self"]))},[(0,s.Lk)("div",F,[(0,s.Lk)("h3",null,(0,h.v_)("buy"===i.tradeType?"Покупка":"Продажа")+" "+(0,h.v_)(i.tradeSymbol),1),(0,s.Lk)("p",null,"Цена: $"+(0,h.v_)((l.getCurrentPrice(i.tradeSymbol)||0).toFixed(2)),1),(0,s.Lk)("div",X,[o[13]||(o[13]=(0,s.Lk)("label",null,"Количество:",-1)),(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":o[0]||(o[0]=t=>i.tradeQuantity=t),type:"number",min:"1"},null,512),[[r.Jo,i.tradeQuantity,void 0,{number:!0}]])]),(0,s.Lk)("p",null,"Стоимость: $"+(0,h.v_)((l.getCurrentPrice(i.tradeSymbol)*i.tradeQuantity).toFixed(2)),1),(0,s.Lk)("div",O,[(0,s.Lk)("button",{onClick:o[1]||(o[1]=(...t)=>l.executeTrade&&l.executeTrade(...t)),disabled:!i.tradeQuantity},"Выполнить",8,j),(0,s.Lk)("button",{onClick:o[2]||(o[2]=t=>i.showDialog=!1)},"Отмена")])])])):(0,s.Q3)("",!0),i.showChartDialog?((0,s.uX)(),(0,s.CE)("div",{key:1,class:"modal",onClick:o[5]||(o[5]=(0,r.D$)(t=>i.showChartDialog=!1,["self"]))},[(0,s.Lk)("div",B,[(0,s.Lk)("h3",null,"График "+(0,h.v_)(i.chartSymbol),1),(0,s.Lk)("div",A,[i.chartData?((0,s.uX)(),(0,s.Wv)(n,{key:0,data:i.chartData,options:i.chartOptions,height:400},null,8,["data","options"])):((0,s.uX)(),(0,s.CE)("div",H," Загрузка данных графика... "))]),(0,s.Lk)("button",{onClick:o[4]||(o[4]=t=>i.showChartDialog=!1)},"Закрыть")])])):(0,s.Q3)("",!0)])}var N=e(787),Q=e(527),q=e(468);q.t1.register(q.PP,q.kc,q.FN,q.No,q.hE,q.m_,q.s$);const V={name:"Broker",components:{Line:Q.N1},data(){return{broker:null,portfolio:null,currentStocks:[],currentDate:"",socket:null,showDialog:!1,tradeSymbol:"",tradeType:"buy",tradeQuantity:1,showChartDialog:!1,chartSymbol:"",chartData:null,priceHistory:{},allStocks:[],chartOptions:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0},tooltip:{mode:"index",intersect:!1}},scales:{x:{display:!0,title:{display:!0,text:"Дата"},ticks:{maxTicksLimit:15}},y:{display:!0,title:{display:!0,text:"Цена ($)"}}}}}},computed:{brokerId(){return this.$route.params.id}},async mounted(){await this.loadAllStocks(),await this.loadBrokerData(),this.setupWebSocket()},beforeUnmount(){this.socket&&this.socket.disconnect()},methods:{async loadAllStocks(){try{const t=await fetch("http://localhost:3001/stocks");this.allStocks=await t.json()}catch(t){console.error("Error loading stocks:",t),this.allStocks=[]}},async loadBrokerData(){try{const t=await fetch(`http://localhost:3002/api/brokers/${this.brokerId}/portfolio`);if(!t.ok)throw new Error(`Portfolio failed: ${t.status}`);const o=await t.json();o.error?(this.portfolio={stocks:[],totalValue:0,totalProfit:0},this.broker={cash:0,name:"Unknown"}):(this.portfolio=o,this.broker=o.broker||{cash:0,name:"Unknown"})}catch(t){console.error("Error loading broker data:",t),this.portfolio={stocks:[],totalValue:0,totalProfit:0},this.broker={cash:0,name:"Error"}}},setupWebSocket(){try{this.socket=(0,N.io)("http://localhost:3001"),this.socket.on("stockUpdate",t=>{this.currentStocks=t||[],t&&t.length>0&&(this.currentDate=t[0].date||""),this.updatePriceHistory(t),this.showChartDialog&&this.chartSymbol&&this.updateChartData(),this.loadBrokerData()}),this.socket.on("portfolioUpdate",t=>{t.brokerId===parseInt(this.brokerId)&&(this.portfolio=t)})}catch(t){console.error("WebSocket setup error:",t)}},getCurrentPrice(t){const o=this.currentStocks.find(o=>o.symbol===t);return o?o.currentPrice:0},updatePriceHistory(t){if(!t||!Array.isArray(t))return;const o=t[0]?.date||(new Date).toLocaleDateString();t.forEach(t=>{t.symbol&&(this.priceHistory[t.symbol]||(this.priceHistory[t.symbol]=[]),this.priceHistory[t.symbol].push({date:o,price:t.currentPrice}),this.priceHistory[t.symbol].length>100&&(this.priceHistory[t.symbol]=this.priceHistory[t.symbol].slice(-100)))})},async showStockChart(t){this.chartSymbol=t,this.showChartDialog=!0,this.updateChartFromHistoricalData()},updateChartFromHistoricalData(){const t=this.allStocks.find(t=>t.symbol===this.chartSymbol);if(!t||!t.historicalData)return void this.updateChartFromHistory();const o=t.historicalData,e=[...o].sort((t,o)=>{const e=this.parseDateToTimestamp(t.date),r=this.parseDateToTimestamp(o.date);return e-r}),r=e.filter((t,o,e)=>0===o||t.date!==e[o-1].date),s=r.map(t=>t.date);this.chartData={labels:s,datasets:[{label:this.chartSymbol,data:r.map(t=>t.open),borderColor:"#007bff",backgroundColor:"rgba(0, 123, 255, 0.1)",tension:.15,fill:!0}]}},parseDateToTimestamp(t){if(!t)return 0;if(t.includes(".")){const o=t.split(".");if(3===o.length){const t=parseInt(o[0]),e=parseInt(o[1])-1,r=parseInt(o[2]),s=new Date(r,e,t);return s.getTime()}}return new Date(t).getTime()},updateChartFromHistory(){const t=this.priceHistory[this.chartSymbol]||[];if(0===t.length)return void(this.chartData={labels:["Нет данных"],datasets:[{label:this.chartSymbol,data:[0],borderColor:"#007bff",backgroundColor:"rgba(0, 123, 255, 0.1)",tension:.15,fill:!0}]});const o=[...t].sort((t,o)=>this.parseDateToTimestamp(t.date)-this.parseDateToTimestamp(o.date)),e=o.filter((t,o,e)=>0===o||t.date!==e[o-1].date);this.chartData={labels:e.map(t=>t.date),datasets:[{label:this.chartSymbol,data:e.map(t=>t.price),borderColor:"#007bff",backgroundColor:"rgba(0, 123, 255, 0.1)",tension:.15,fill:!0}]}},updateChartData(){this.updateChartFromHistory()},openTradeDialog(t,o){this.tradeSymbol=t,this.tradeType=o,this.tradeQuantity=1,this.showDialog=!0},closeDialog(){this.showDialog=!1},async executeTrade(){try{const t=this.getCurrentPrice(this.tradeSymbol);if(!t)return void alert("Не удалось получить текущую цену");const o="buy"===this.tradeType?"buy":"sell",e=await fetch(`http://localhost:3002/api/brokers/${this.brokerId}/${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbol:this.tradeSymbol,quantity:this.tradeQuantity})}),r=await e.json();r.success?(await this.loadBrokerData(),this.closeDialog()):alert("Ошибка операции")}catch(t){console.error("Trade error:",t),alert("Ошибка операции")}},getProfitClass(t){return t>=0?"profit":"loss"},getStockProfitClass(t){return(t.profit||0)>=0?"profit":"loss"}}},W=(0,l.A)(V,[["render",U],["__scopeId","data-v-0eb59c5c"]]),K=W,J={class:"admin"},M={class:"header"},R={class:"main"},z={class:"current-info"},G={key:0,class:"empty"},Y={key:1,class:"portfolios"},Z={class:"portfolio-header"},tt={class:"portfolio-details"},ot={class:"cash"},et={key:0,class:"stocks"},rt={class:"symbol"},st={class:"quantity"},at={class:"avg-price"},it={class:"price"},lt={key:1,class:"no-stocks"};function nt(t,o,e,r,a,i){return(0,s.uX)(),(0,s.CE)("div",J,[(0,s.Lk)("header",M,[o[1]||(o[1]=(0,s.Lk)("h1",null,"Портфели брокеров",-1)),(0,s.Lk)("button",{onClick:o[0]||(o[0]=o=>t.$router.push("/")),class:"back-btn"},"← Назад")]),(0,s.Lk)("main",R,[(0,s.Lk)("div",z,[(0,s.Lk)("p",null,[o[2]||(o[2]=(0,s.Lk)("strong",null,"Текущая дата:",-1)),(0,s.eW)(" "+(0,h.v_)(a.currentDate),1)])]),0===a.portfolios.length?((0,s.uX)(),(0,s.CE)("div",G,[...o[3]||(o[3]=[(0,s.Lk)("p",null,"Нет данных о портфелях",-1)])])):((0,s.uX)(),(0,s.CE)("div",Y,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(i.validPortfolios,t=>((0,s.uX)(),(0,s.CE)("div",{key:t.brokerId,class:"portfolio"},[(0,s.Lk)("div",Z,[(0,s.Lk)("h2",null,(0,h.v_)(t.brokerName||`Брокер ${t.brokerId}`),1),(0,s.Lk)("div",{class:(0,h.C4)(["portfolio-total",i.getProfitClass(t.totalProfit||0)])}," $"+(0,h.v_)((t.totalValue||0).toLocaleString()),3)]),(0,s.Lk)("div",tt,[(0,s.Lk)("div",ot,"Наличные: $"+(0,h.v_)((t.cash||0).toLocaleString()),1),t.stocks&&t.stocks.length>0?((0,s.uX)(),(0,s.CE)("div",et,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(t.stocks,t=>((0,s.uX)(),(0,s.CE)("div",{key:t.symbol,class:"stock"},[(0,s.Lk)("span",rt,(0,h.v_)(t.symbol),1),(0,s.Lk)("span",st,(0,h.v_)(t.quantity||0)+" шт",1),(0,s.Lk)("span",at,"$"+(0,h.v_)((t.averagePrice||0).toFixed(2)),1),(0,s.Lk)("span",it,"$"+(0,h.v_)((i.getCurrentStockPrice(t.symbol)||0).toFixed(2)),1),(0,s.Lk)("span",{class:(0,h.C4)(["value",i.getStockProfitClass(i.calculateStockProfit(t))])}," $"+(0,h.v_)((i.calculateStockProfit(t)||0).toFixed(2)),3)]))),128))])):((0,s.uX)(),(0,s.CE)("div",lt," Нет акций "))])]))),128))]))])])}const ct={data(){return{portfolios:[],currentPrices:{},socket:null,currentDate:"",brokers:[]}},computed:{validPortfolios(){return this.portfolios.filter(t=>{if(t.brokerName&&""!==t.brokerName.trim())return!0;const o=this.brokers.some(o=>o.id===t.brokerId);return o})}},async mounted(){await this.loadBrokers(),await this.loadPortfolios(),this.setupWebSocket()},beforeUnmount(){this.socket&&this.socket.disconnect()},methods:{async loadBrokers(){try{const t=await fetch("http://localhost:3001/brokers");this.brokers=await t.json(),console.log("Loaded brokers from admin:",this.brokers)}catch(t){console.error("Error loading brokers:",t),this.brokers=[]}},async loadPortfolios(){try{const t=await fetch("http://localhost:3002/api/portfolios"),o=await t.json();o.success&&(this.portfolios=o.data||[],console.log("Loaded portfolios:",this.portfolios))}catch(t){console.error("Error loading portfolios:",t),this.portfolios=[]}},setupWebSocket(){this.socket=(0,N.io)("http://localhost:3002"),this.socket.on("priceUpdate",t=>{this.currentPrices=t.prices||{},this.currentDate=t.date||""}),this.socket.on("portfolioUpdate",t=>{this.handlePortfolioUpdate(t)});const t=(0,N.io)("http://localhost:3001");t.on("stockUpdate",t=>{t&&Array.isArray(t)&&t.forEach(t=>{this.currentPrices[t.symbol]=t.currentPrice}),t&&t.length>0&&(this.currentDate=t[0].date||"")}),t.on("brokersUpdated",async()=>{await this.loadBrokers()})},handlePortfolioUpdate(t){const o=this.portfolios.findIndex(o=>o.brokerId===t.brokerId);-1!==o?this.portfolios.splice(o,1,t):this.portfolios.push(t)},getCurrentStockPrice(t){return this.currentPrices[t]||0},calculateStockProfit(t){const o=this.getCurrentStockPrice(t.symbol),e=o*t.quantity,r=t.averagePrice*t.quantity;return e-r},getProfitClass(t){return t>=0?"profit":"loss"},getStockProfitClass(t){return t>=0?"profit":"loss"}}},dt=(0,l.A)(ct,[["render",nt],["__scopeId","data-v-02e45efc"]]),ut=dt,ht=[{path:"/",component:g},{path:"/broker/:id",component:K},{path:"/admin",component:ut}],kt=(0,u.aE)({history:(0,u.LA)(),routes:ht}),pt=kt;(0,r.Ef)(d).use(pt).mount("#app")}},o={};function e(r){var s=o[r];if(void 0!==s)return s.exports;var a=o[r]={exports:{}};return t[r](a,a.exports,e),a.exports}e.m=t,(()=>{var t=[];e.O=(o,r,s,a)=>{if(!r){var i=1/0;for(d=0;d<t.length;d++){for(var[r,s,a]=t[d],l=!0,n=0;n<r.length;n++)(!1&a||i>=a)&&Object.keys(e.O).every(t=>e.O[t](r[n]))?r.splice(n--,1):(l=!1,a<i&&(i=a));if(l){t.splice(d--,1);var c=s();void 0!==c&&(o=c)}}return o}a=a||0;for(var d=t.length;d>0&&t[d-1][2]>a;d--)t[d]=t[d-1];t[d]=[r,s,a]}})(),(()=>{e.d=(t,o)=>{for(var r in o)e.o(o,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:o[r]})}})(),(()=>{e.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}()})(),(()=>{e.o=(t,o)=>Object.prototype.hasOwnProperty.call(t,o)})(),(()=>{e.r=t=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}})(),(()=>{var t={524:0};e.O.j=o=>0===t[o];var o=(o,r)=>{var s,a,[i,l,n]=r,c=0;if(i.some(o=>0!==t[o])){for(s in l)e.o(l,s)&&(e.m[s]=l[s]);if(n)var d=n(e)}for(o&&o(r);c<i.length;c++)a=i[c],e.o(t,a)&&t[a]&&t[a][0](),t[a]=0;return e.O(d)},r=self["webpackChunkbroker_frontend"]=self["webpackChunkbroker_frontend"]||[];r.forEach(o.bind(null,0)),r.push=o.bind(null,r.push.bind(r))})();var r=e.O(void 0,[504],()=>e(873));r=e.O(r)})();
//# sourceMappingURL=app.30b43043.js.map